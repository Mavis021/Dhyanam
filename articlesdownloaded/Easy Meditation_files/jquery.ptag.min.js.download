(function(b){b.fn.ptag=function(){var c=new Array;b.each(this,function(e){var f=b(this).attr("id");var d=f.replace("ptag_box","");b(this).attr("idx",d);b("#tag_txt"+d).attr("idx",d);if(b("#tag_txt"+d).attr("alt")!="undefined"){if(b("#tags"+d).val().length==0){b("#tag_txt"+d).val(b("#tag_txt"+d).attr("alt"))}}b("#tag_txt"+d).autocomplete({autoFocus:true,minLength:2,appendTo:"#ptag_box"+d,response:function(g,h){if(h.content.length===0){content.showMessage("No Results Found","error")}},source:function(j,k){var i=/^[a-zA-Z0-9_ -&]+$/;if(j.term.length>0&&i.test(j.term)==false){var g=[];k(g);b(this).trigger("change");return}var h=Math.floor((Math.random()*100000)+1);b.ajax({type:"POST",url:base_url+"/topic/termsjson/"+h,dataType:"json",data:{term:j.term},success:function(m){var n=false;var l=[];b.each(m,function(o,p){c[p.name]=o;c.push(o,p.name);l.push(p.name);if(b.trim(p.name.toLowerCase())==b.trim(j.term.toLowerCase())){n=true}});k(l)}})},select:function(m,o){var q=b(this).attr("idx");var l=o.item.value;var j=(l.length)-1;if(l[j]=="*"){l=l.substr(0,j)}var p=b("#tags"+q).val();if(p!=""){var h=p.split("|");for(var k=0;k<h.length;k++){if(h[k]==l){return false}}}span=b("<span id='tt"+q+"'>").text(l),a=b("<a>").addClass("remove").attr({href:"javascript:",title:"Remove "+l,val:l}).text("x").appendTo(span);span.insertBefore(this);if(p==""){var g=c[l];b("#tags"+q).val(g)}else{var g=c[l];var n=p+"|"+g;b("#tags"+q).val(n)}b("#tags"+q).trigger("change")},close:function(h,g){if(h.which==1||h.which==13){b(this).val("")}},change:function(){b(this).css("top",2)}});b("#ptag_box"+d).click(function(){var g=b(this).attr("idx");b("#tag_txt"+g).focus()});b("#tag_txt"+d).focus(function(){if(b(this).attr("alt")!="undefined"){if(b(this).val()==b(this).attr("alt")){b(this).val("")}}});b("#tag_txt"+d).blur(function(){if(b(this).attr("alt")!="undefined"){var g=b(this).attr("idx");if(b("#tags"+g).val().length==0){b(this).val(b(this).attr("alt"))}}});b("#ptag_box"+d).on("click",".remove",function(){var h=b(this).parent().parent().attr("idx");var g=b(this).attr("val");var l=b("#tags"+h).val();var j=l.split("|");var m="";for(var k=0;k<j.length;k++){if(j[k]!=c[g]){if(m==""){m=j[k]}else{m=m+"|"+j[k]}}}b("#tags"+h).val(m);b(this).parent().remove();if(b("#ptag_box"+h+" span").length===0){b("#tag_txt"+h).css("top",0)}b("#tags"+h).trigger("change")})})}})(jQuery);